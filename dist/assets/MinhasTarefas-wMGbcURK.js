import{d as Y,r as k,c as d,I as Z,o as j,p as ss,b as l,f as a,i as p,n as g,t as v,g as $,F as H,h as Q,z as X,v as ts,x as as,l as n}from"./vendor-B3fty_EA.js";import{a as K,_ as os,e as es,u as is}from"./index-16tKPmdB.js";import"./utils-DowPLjG-.js";import"./charts-CUJbImKC.js";const rs=Y("tarefasAuditoria",()=>{const b=k({}),S=300*1e3,r=k("etiqueta"),w=k(null),P=k(!1),q=k(!1),f=k(null),c=k({}),E=k({}),A=d(()=>e=>{const i=b.value[e];return!i||Date.now()-i.timestamp>S?null:i.data}),M=d(()=>e=>{const i=A.value(e);if(!i)return[];const t=i[r.value]||[];return[...new Set(t.map(o=>o.local||"Sem Corredor").filter(o=>o&&o!=="N/A"))].sort()}),x=d(()=>e=>{const i=A.value(e);return!i||!w.value?[]:(i[r.value]||[]).filter(s=>(s.local||"Sem Corredor")===w.value).map(s=>({...s,verificado:T(e,r.value,s.codigo)}))}),u=d(()=>e=>x.value(e).filter(t=>!C(t)&&!t.verificado)),U=d(()=>e=>{const i=x.value(e),t=i.length,s=i.filter(L=>C(L)).length,o=i.filter(L=>L.verificado).length,m=t-s-o;return{total:t,lidos:s,verificados:o,faltam:m>0?m:0,progresso:t>0?Math.round((s+o)/t*100):0}}),G=d(()=>e=>{const i=A.value(e);if(!i)return{total:0,lidos:0,faltam:0,progresso:0};const t=i[r.value]||[],s=t.length,o=t.filter(m=>C(m)).length;return{total:s,lidos:o,faltam:s-o,progresso:s>0?Math.round(o/s*100):0}});function C(e){return(e.situacao||e.situacaoAuditoria||"Não lido")==="Atualizado"||e.auditadoDia&&e.auditadoDia!==""}function y(e,i,t){return`${e}::${i}::${t}`}function T(e,i,t){return!!c.value[y(e,i,t)]}async function V(e,i=!1){if(!e)return f.value="ID da loja não fornecido",null;if(!i&&b.value[e]){const t=b.value[e];if(Date.now()-t.timestamp<S&&t.versao===E.value[e])return t.data}P.value=!0,f.value=null;try{const t=await K.get(`/api/audit-products/produtos-auditorias/${e}`);if(!t.data.success)throw new Error(t.data.message||"Erro ao carregar produtos");const s=t.data.produtos,o=Date.now();return E.value[e]&&_(s,e)&&N(e),E.value[e]=o,b.value[e]={data:s,timestamp:o,versao:o},s}catch(t){return f.value=t.message,console.error("❌ Erro ao carregar produtos:",t),null}finally{P.value=!1}}function _(e,i){const t=b.value[i];if(!t)return!1;const s=t.data?.etiqueta?.length||0,o=e?.etiqueta?.length||0;return Math.abs(s-o)>10}function O(e,i,t){const s=y(e,i,t);c.value[s]?delete c.value[s]:c.value[s]=!0,z(e),h(e,i)}function D(e,i,t,s=!0){t.forEach(o=>{const m=y(e,i,o);s?c.value[m]=!0:delete c.value[m]}),z(e),h(e,i)}function N(e){const i=`${e}::`,t={};Object.keys(c.value).forEach(s=>{s.startsWith(i)||(t[s]=c.value[s])}),c.value=t,z(e)}function z(e){try{const i={},t=`${e}::`;Object.keys(c.value).forEach(s=>{s.startsWith(t)&&(i[s]=!0)}),localStorage.setItem(`checklist_auditoria_${e}`,JSON.stringify(i))}catch(i){console.error("Erro ao salvar checklist local:",i)}}function B(e){try{const i=localStorage.getItem(`checklist_auditoria_${e}`);if(i){const t=JSON.parse(i);Object.keys(t).forEach(s=>{c.value[s]=!0})}}catch(i){console.error("Erro ao carregar checklist local:",i)}}async function h(e,i){try{const t=`${e}::${i}::`,s=[];Object.keys(c.value).forEach(o=>{o.startsWith(t)&&s.push(o.replace(t,""))}),await K.post("/api/tarefas-auditoria/checklist",{lojaId:e,tipo:i,itensVerificados:s})}catch(t){console.warn("Não foi possível salvar checklist no backend:",t.message)}}async function F(e,i){q.value=!0;try{const t=await K.get(`/api/tarefas-auditoria/checklist/${e}/${i}`);if(t.data.success&&t.data.checklist){const{tipo:s,itensVerificados:o}=t.data.checklist;o.forEach(m=>{const L=y(e,s,m);c.value[L]=!0})}}catch{B(e)}finally{q.value=!1}}function J(e){r.value=e,w.value=null}function W(e){w.value=e}function I(e){const i=b.value[e];if(!i)return null;const t=Date.now(),s=Math.floor((t-i.timestamp)/1e3),o=t-i.timestamp<S;return{timestamp:i.timestamp,idade:`${s}s`,valido:o}}async function R(e,i){B(e),await V(e),i&&await F(e,i)}return{produtosCache:b,tipoAuditoriaSelecionado:r,corredorSelecionado:w,loading:P,loadingChecklist:q,error:f,itensVerificados:c,getProdutosPorLoja:A,getCorredores:M,getProdutosCorredor:x,getProdutosFaltam:u,getEstatisticasCorredor:U,getEstatisticasGerais:G,carregarProdutos:V,toggleItemVerificado:O,marcarVariosItens:D,limparChecklistLoja:N,selecionarTipoAuditoria:J,selecionarCorredor:W,getInfoCache:I,inicializar:R,isItemVerificado:T,isItemLido:C}}),ls={class:"minhas-tarefas"},ns={class:"tipo-auditoria-selector"},cs={class:"segmented-control"},us={key:0,class:"loading-state"},ds={key:1,class:"error-state"},vs={key:2,class:"empty-state"},fs={key:3,class:"tarefas-content"},ps={class:"stats-gerais"},ms={class:"stat-card-mini"},gs={class:"stat-info-mini"},hs={class:"stat-value-mini"},ks={class:"stat-card-mini lidos"},bs={class:"stat-info-mini"},Cs={class:"stat-value-mini"},ys={class:"stat-card-mini faltam"},_s={class:"stat-info-mini"},Ss={class:"stat-value-mini"},$s={class:"stat-card-mini progresso"},ws={class:"stat-info-mini"},Es={class:"stat-value-mini"},As={class:"corredor-selector"},xs={class:"corredores-grid"},Ts=["onClick"],Vs={class:"corredor-nome"},Ls={class:"corredor-count"},Ps={key:0,class:"corredor-itens"},qs={class:"corredor-header"},Ds={class:"corredor-title"},Ms={class:"progresso-bar-container"},Ns={class:"progresso-bar"},zs={class:"progresso-legenda"},Fs={class:"legenda-item lidos"},Os={class:"legenda-item verificados"},Bs={class:"legenda-item faltam"},Us={class:"corredor-acoes"},Gs={class:"filtro-itens"},Js={class:"acoes-lote"},Ws={class:"busca-container"},Is={key:0,class:"itens-lista"},Rs=["onClick"],Ks={class:"item-check"},Hs={key:0,class:"fas fa-check"},Qs={class:"item-info"},Xs=["title"],Ys={class:"item-meta"},Zs={class:"item-codigo"},js={key:0,class:"item-classe"},st={key:1,class:"item-estoque"},tt={class:"item-status"},at={key:0,class:"status-badge lido"},ot={key:1,class:"status-badge verificado"},et={key:2,class:"status-badge pendente"},it={key:1,class:"itens-vazio"},rt={key:0},lt={key:1},nt={key:2},ct={key:2,class:"cache-info"},ut=["disabled"],dt={__name:"MinhasTarefas",props:{usuario:{type:Object,required:!0}},setup(b){const S=b,r=rs(),w=es(),P=is(),{lojaSelecionada:q}=Z(w),f=k("faltam"),c=k(""),E=d(()=>r.loading),A=d(()=>r.error),M=d(()=>r.tipoAuditoriaSelecionado),x=d(()=>r.corredorSelecionado),u=d(()=>S.usuario?.loja?._id||S.usuario?.loja?.codigo||q.value?._id||q.value?.codigo||null),U=d(()=>{if(!u.value)return!1;const t=r.getProdutosPorLoja(u.value);if(!t)return!1;const s=r.tipoAuditoriaSelecionado;return(t[s]?.length||0)>0}),G=d(()=>u.value?r.getCorredores(u.value):[]),C=d(()=>u.value?r.getEstatisticasGerais(u.value):{total:0,lidos:0,faltam:0,progresso:0}),y=d(()=>u.value?r.getProdutosCorredor(u.value):[]),T=d(()=>y.value.filter(t=>!h(t)&&!t.verificado)),V=d(()=>y.value.filter(t=>t.verificado&&!h(t))),_=d(()=>u.value?r.getEstatisticasCorredor(u.value):{total:0,lidos:0,verificados:0,faltam:0,progresso:0}),O=d(()=>{let t;if(f.value==="faltam"?t=T.value:f.value==="verificados"?t=V.value:t=y.value,c.value){const s=c.value.toLowerCase();t=t.filter(o=>(o.nome||"").toLowerCase().includes(s)||(o.codigo||"").toLowerCase().includes(s))}return t}),D=d(()=>u.value?r.getInfoCache(u.value):null),N=d(()=>{const t=_.value;return t.total===0?0:Math.round(t.lidos/t.total*100)}),z=d(()=>{const t=_.value;return t.total===0?0:Math.round(t.verificados/t.total*100)}),B=d(()=>{const t=_.value.progresso;return t>=80?"progresso-alto":t>=50?"progresso-medio":"progresso-baixo"});function h(t){return r.isItemLido(t)}function F(t){r.selecionarTipoAuditoria(t),f.value="faltam"}function J(t){r.selecionarCorredor(t),f.value="faltam",c.value=""}function W(t){h(t)||r.toggleItemVerificado(u.value,r.tipoAuditoriaSelecionado,t.codigo)}function I(){const t=T.value.map(s=>s.codigo);r.marcarVariosItens(u.value,r.tipoAuditoriaSelecionado,t,!0)}function R(){const t=V.value.map(s=>s.codigo);r.marcarVariosItens(u.value,r.tipoAuditoriaSelecionado,t,!1)}function e(t){if(!u.value)return 0;const s=r.getProdutosPorLoja(u.value);if(!s)return 0;const o=r.tipoAuditoriaSelecionado;return(s[o]||[]).filter(L=>(L.local||"Sem Corredor")===t).length}async function i(t=!1){u.value&&await r.carregarProdutos(u.value,t)}return j(async()=>{if(u.value){const t=S.usuario?.id||P.getUsuarioId;await r.inicializar(u.value,t)}}),ss(u,async t=>{if(t){const s=S.usuario?.id||P.getUsuarioId;await r.inicializar(t,s)}}),(t,s)=>(n(),l("div",ls,[s[41]||(s[41]=a("div",{class:"tarefas-header"},[a("h2",null,[a("i",{class:"fas fa-tasks"}),p(" Minhas Tarefas de Auditoria ")]),a("p",{class:"subtitle"}," Escolha o corredor e acompanhe os itens que faltam ser auditados ")],-1)),a("div",ns,[a("div",cs,[a("button",{class:g({active:M.value==="etiqueta"}),onClick:s[0]||(s[0]=o=>F("etiqueta"))},[...s[10]||(s[10]=[a("i",{class:"fas fa-tag"},null,-1),p(" Etiqueta ",-1)])],2),a("button",{class:g({active:M.value==="presenca"}),onClick:s[1]||(s[1]=o=>F("presenca"))},[...s[11]||(s[11]=[a("i",{class:"fas fa-eye"},null,-1),p(" Presença ",-1)])],2),a("button",{class:g({active:M.value==="ruptura"}),onClick:s[2]||(s[2]=o=>F("ruptura"))},[...s[12]||(s[12]=[a("i",{class:"fas fa-exclamation-triangle"},null,-1),p(" Ruptura ",-1)])],2)])]),E.value?(n(),l("div",us,[...s[13]||(s[13]=[a("div",{class:"spinner"},null,-1),a("p",null,"Carregando itens da auditoria...",-1)])])):A.value?(n(),l("div",ds,[s[15]||(s[15]=a("i",{class:"fas fa-exclamation-circle"},null,-1)),a("p",null,v(A.value),1),a("button",{class:"btn-retry",onClick:s[3]||(s[3]=o=>i(!0))},[...s[14]||(s[14]=[a("i",{class:"fas fa-redo"},null,-1),p(" Tentar novamente ",-1)])])])):U.value?(n(),l("div",fs,[a("div",ps,[a("div",ms,[s[18]||(s[18]=a("div",{class:"stat-icon-mini"},[a("i",{class:"fas fa-box"})],-1)),a("div",gs,[a("span",hs,v(C.value.total),1),s[17]||(s[17]=a("span",{class:"stat-label-mini"},"Total Itens",-1))])]),a("div",ks,[s[20]||(s[20]=a("div",{class:"stat-icon-mini"},[a("i",{class:"fas fa-check"})],-1)),a("div",bs,[a("span",Cs,v(C.value.lidos),1),s[19]||(s[19]=a("span",{class:"stat-label-mini"},"Já Lidos",-1))])]),a("div",ys,[s[22]||(s[22]=a("div",{class:"stat-icon-mini"},[a("i",{class:"fas fa-clock"})],-1)),a("div",_s,[a("span",Ss,v(C.value.faltam),1),s[21]||(s[21]=a("span",{class:"stat-label-mini"},"Faltam",-1))])]),a("div",$s,[s[24]||(s[24]=a("div",{class:"stat-icon-mini"},[a("i",{class:"fas fa-chart-pie"})],-1)),a("div",ws,[a("span",Es,v(C.value.progresso)+"%",1),s[23]||(s[23]=a("span",{class:"stat-label-mini"},"Progresso",-1))])])]),a("div",As,[s[26]||(s[26]=a("h3",null,[a("i",{class:"fas fa-map-marker-alt"}),p(" Escolha seu Corredor")],-1)),a("div",xs,[(n(!0),l(H,null,Q(G.value,o=>(n(),l("button",{key:o,class:g(["corredor-card",{active:x.value===o}]),onClick:m=>J(o)},[s[25]||(s[25]=a("div",{class:"corredor-icon"},[a("i",{class:"fas fa-road"})],-1)),a("span",Vs,v(o),1),a("span",Ls,v(e(o))+" itens ",1)],10,Ts))),128))])]),x.value?(n(),l("div",Ps,[a("div",qs,[a("div",Ds,[a("h3",null,[s[27]||(s[27]=a("i",{class:"fas fa-clipboard-list"},null,-1)),p(" Corredor "+v(x.value),1)]),a("span",{class:g(["corredor-badge",B.value])},v(_.value.progresso)+"% concluído ",3)]),a("div",Ms,[a("div",Ns,[a("div",{class:"progresso-fill lidos-fill",style:X({width:N.value+"%"})},null,4),a("div",{class:"progresso-fill verificados-fill",style:X({width:z.value+"%",left:N.value+"%"})},null,4)]),a("div",zs,[a("span",Fs,[s[28]||(s[28]=a("span",{class:"legenda-dot"},null,-1)),p(" "+v(_.value.lidos)+" lidos no sistema ",1)]),a("span",Os,[s[29]||(s[29]=a("span",{class:"legenda-dot"},null,-1)),p(" "+v(_.value.verificados)+" verificados por você ",1)]),a("span",Bs,[s[30]||(s[30]=a("span",{class:"legenda-dot"},null,-1)),p(" "+v(_.value.faltam)+" faltam ",1)])])]),a("div",Us,[a("div",Gs,[a("button",{class:g({active:f.value==="todos"}),onClick:s[4]||(s[4]=o=>f.value="todos")}," Todos ("+v(y.value.length)+") ",3),a("button",{class:g({active:f.value==="faltam"}),onClick:s[5]||(s[5]=o=>f.value="faltam")}," Faltam ("+v(T.value.length)+") ",3),a("button",{class:g({active:f.value==="verificados"}),onClick:s[6]||(s[6]=o=>f.value="verificados")}," Verificados ("+v(V.value.length)+") ",3)]),a("div",Js,[f.value==="faltam"&&T.value.length>0?(n(),l("button",{key:0,class:"btn-lote",onClick:I},[...s[31]||(s[31]=[a("i",{class:"fas fa-check-double"},null,-1),p(" Marcar todos ",-1)])])):$("",!0),f.value==="verificados"&&V.value.length>0?(n(),l("button",{key:1,class:"btn-lote desmarcar",onClick:R},[...s[32]||(s[32]=[a("i",{class:"fas fa-times"},null,-1),p(" Desmarcar todos ",-1)])])):$("",!0)])])]),a("div",Ws,[s[34]||(s[34]=a("i",{class:"fas fa-search"},null,-1)),ts(a("input",{"onUpdate:modelValue":s[7]||(s[7]=o=>c.value=o),type:"text",placeholder:"Buscar produto por nome ou código...",class:"busca-input"},null,512),[[as,c.value]]),c.value?(n(),l("button",{key:0,class:"btn-limpar-busca",onClick:s[8]||(s[8]=o=>c.value="")},[...s[33]||(s[33]=[a("i",{class:"fas fa-times"},null,-1)])])):$("",!0)]),O.value.length>0?(n(),l("div",Is,[(n(!0),l(H,null,Q(O.value,o=>(n(),l("div",{key:o.codigo,class:g(["item-card",{"item-lido":h(o),"item-verificado":o.verificado,"item-falta":!h(o)&&!o.verificado}]),onClick:m=>W(o)},[a("div",Ks,[a("div",{class:g(["checkbox",{checked:o.verificado||h(o)}])},[o.verificado||h(o)?(n(),l("i",Hs)):$("",!0)],2)]),a("div",Qs,[a("div",{class:"item-nome",title:o.nome},v(o.nome),9,Xs),a("div",Ys,[a("span",Zs,[s[35]||(s[35]=a("i",{class:"fas fa-barcode"},null,-1)),p(" "+v(o.codigo),1)]),o.classe?(n(),l("span",js,v(o.classe),1)):$("",!0),o.estoque?(n(),l("span",st," Est: "+v(o.estoque||o.estoqueAtual||0),1)):$("",!0)])]),a("div",tt,[h(o)?(n(),l("span",at,[...s[36]||(s[36]=[a("i",{class:"fas fa-check-circle"},null,-1),p(" Lido ",-1)])])):o.verificado?(n(),l("span",ot,[...s[37]||(s[37]=[a("i",{class:"fas fa-user-check"},null,-1),p(" Verificado ",-1)])])):(n(),l("span",et,[...s[38]||(s[38]=[a("i",{class:"fas fa-clock"},null,-1),p(" Pendente ",-1)])]))])],10,Rs))),128))])):(n(),l("div",it,[s[39]||(s[39]=a("i",{class:"fas fa-check-circle"},null,-1)),f.value==="faltam"?(n(),l("p",rt," Todos os itens deste corredor foram verificados! ")):c.value?(n(),l("p",lt,' Nenhum item encontrado para "'+v(c.value)+'" ',1)):(n(),l("p",nt,"Nenhum item neste corredor."))])),D.value?(n(),l("div",ct,[s[40]||(s[40]=a("i",{class:"fas fa-database"},null,-1)),p(" Cache: "+v(D.value.idade)+" ",1),a("span",{class:g(D.value.valido?"cache-ok":"cache-expirado")},v(D.value.valido?"✅":"⚠️ Expirado"),3),a("button",{class:"btn-refresh",onClick:s[9]||(s[9]=o=>i(!0)),disabled:E.value},[a("i",{class:g(["fas fa-sync-alt",{"fa-spin":E.value}])},null,2)],8,ut)])):$("",!0)])):$("",!0)])):(n(),l("div",vs,[...s[16]||(s[16]=[a("i",{class:"fas fa-inbox"},null,-1),a("h3",null,"Nenhuma auditoria disponível",-1),a("p",null,"Não há dados de auditoria para esta loja no momento.",-1),a("p",{class:"info-text"}," Aguarde o upload de uma nova planilha de auditoria ou selecione outra loja. ",-1)])]))]))}},gt=os(dt,[["__scopeId","data-v-b76a8fcc"]]);export{gt as default};
